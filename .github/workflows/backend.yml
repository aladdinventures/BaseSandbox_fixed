
name: Backend CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'config/projects.yaml'
      - 'infra/ci-cd/mamos_runner.py'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment (e.g., Test, Staging, Production)'
        required: false
        type: string

env:
  PYTHONUNBUFFERED: "1"

jobs:
  build-test-healthcheck:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push reports back to the repository
      pull-requests: write # Potentially required for PR status updates
      checks: write # Required for check runs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Run MAMOS Build, Test, and Health Check for Backend
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }} # Render API Key for deployments
        run: |
          python infra/ci-cd/mamos_runner.py --project backend

      - name: Upload CI/CD Reports
        uses: actions/upload-artifact@v4
        with:
          name: mamos-ci-cd-reports-backend
          path: reports/

      - name: Commit and Push Reports (if successful)
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "CI/CD: MAMOS reports for backend" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }} # Use a PAT with repo scope for pushing

  deploy-test:
    needs: build-test-healthcheck
    runs-on: ubuntu-latest
    environment:
      name: Test
      url: https://test.backend.aladdin.com
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Deploy Backend to Test environment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          python infra/ci-cd/mamos_runner.py --project backend --deploy-env Test

      - name: Upload CI/CD Reports
        uses: actions/upload-artifact@v4
        with:
          name: mamos-ci-cd-reports-backend-deploy-test
          path: reports/

      - name: Commit and Push Reports (if successful)
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "CI/CD: MAMOS deployment reports for backend (Test)" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

  deploy-staging:
    needs: deploy-test
    runs-on: ubuntu-latest
    environment:
      name: Staging
      url: https://staging.backend.aladdin.com
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Manual Approval Required for Staging Deployment
        run: |
          echo "********************************************************************************"
          echo "* MANUAL APPROVAL REQUIRED: Deployment to Staging Environment.                 *"
          echo "*                                                                              *"
          echo "* Please review the changes and approve this deployment in the GitHub Actions  *"
          echo "* interface. This ensures all prerequisites are met before proceeding.         *"
          echo "*                                                                              *"
          echo "* Prerequisites:                                                               *"
          echo "* - All automated tests have passed.                                           *"
          echo "* - Code review for the merged changes is complete.                            *"
          echo "* - Necessary Render Service IDs and API Keys are configured for Staging.      *"
          echo "********************************************************************************"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Deploy Backend to Staging environment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          python infra/ci-cd/mamos_runner.py --project backend --deploy-env Staging

      - name: Upload CI/CD Reports
        uses: actions/upload-artifact@v4
        with:
          name: mamos-ci-cd-reports-backend-deploy-staging
          path: reports/

      - name: Commit and Push Reports (if successful)
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "CI/CD: MAMOS deployment reports for backend (Staging)" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: Production
      url: https://production.backend.aladdin.com
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Manual Approval Required for Production Deployment
        run: |
          echo "********************************************************************************"
          echo "* MANUAL APPROVAL REQUIRED: Deployment to Production Environment.              *"
          echo "*                                                                              *"
          echo "* Please review the changes and approve this deployment in the GitHub Actions  *"
          echo "* interface. This ensures all prerequisites are met before proceeding.         *"
          echo "*                                                                              *"
          echo "* Prerequisites:                                                               *"
          echo "* - All automated tests have passed.                                           *"
          echo "* - Code review for the merged changes is complete.                            *"
          echo "* - Necessary Render Service IDs and API Keys are configured for Production.   *"
          echo "* - Staging deployment has been successfully verified.                         *"
          echo "********************************************************************************"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Deploy Backend to Production environment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          python infra/ci-cd/mamos_runner.py --project backend --deploy-env Production

      - name: Upload CI/CD Reports
        uses: actions/upload-artifact@v4
        with:
          name: mamos-ci-cd-reports-backend-deploy-production
          path: reports/

      - name: Commit and Push Reports (if successful)
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "CI/CD: MAMOS deployment reports for backend (Production)" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

